name: Release Build and Upload

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build_and_release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build executable (Linux/AMD64)
        run: cargo build --release

      - name: Prepare Release Assets
        id: prepare
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME}"
          BINARY_NAME="pwgen"
          OS_ARCH="linux-amd64"

          BUILD_PATH="target/release/$BINARY_NAME"

          ZIP_FILENAME="${BINARY_NAME}-${VERSION}-${OS_ARCH}.zip"
          CHECKSUM_FILENAME="checksums.txt"

          echo "--- Preparing Assets for Release $VERSION ---"

          zip -j "$ZIP_FILENAME" "$BUILD_PATH"
          echo "Generated ZIP: $ZIP_FILENAME"

          sha256sum "$ZIP_FILENAME" > "$CHECKSUM_FILENAME"
          echo "Generated Checksum: $CHECKSUM_FILENAME"
          cat "$CHECKSUM_FILENAME"

          echo "zip_filename=$ZIP_FILENAME" >> "$GITHUB_OUTPUT"
          echo "checksum_filename=$CHECKSUM_FILENAME" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            ${{ steps.prepare.outputs.zip_filename }}
            ${{ steps.prepare.outputs.checksum_filename }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
